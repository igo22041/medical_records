# Деплой на Railway

Это руководство поможет вам задеплоить проект Medical Records System на Railway.

## Предварительные требования

1. Аккаунт на [Railway](https://railway.app)
2. Git репозиторий с вашим проектом (GitHub, GitLab, или Bitbucket)

## Шаги деплоя

### 1. Подключение репозитория

1. Войдите в Railway Dashboard
2. Нажмите "New Project"
3. Выберите "Deploy from GitHub repo" (или другой Git провайдер)
4. Выберите ваш репозиторий

### 2. Добавление базы данных MySQL

1. В проекте Railway нажмите "+ New"
2. Выберите "Database" → "Add MySQL"
3. Railway автоматически создаст базу данных и установит переменные окружения:
   - `MYSQL_HOST`
   - `MYSQL_DATABASE`
   - `MYSQL_USER`
   - `MYSQL_PASSWORD`
   - `MYSQL_PORT`

### 3. Инициализация базы данных

После создания базы данных, вам нужно выполнить SQL скрипты для создания таблиц:

1. В Railway Dashboard откройте вашу MySQL базу данных
2. Перейдите на вкладку "Data" или используйте "Query"
3. Выполните SQL из файла `database/init.sql`
4. Если есть миграции, выполните их также:
   - `database/migration_add_status.sql`
   - `database/migration_add_attachment.sql`

### 4. Настройка переменных окружения (опционально)

Railway автоматически установит переменные для MySQL. Если нужно настроить дополнительные:

1. В проекте Railway откройте ваш сервис (веб-приложение)
2. Перейдите на вкладку "Variables"
3. Добавьте при необходимости:
   - `APP_ENV=production`
   - `APP_DEBUG=false`

### 5. Деплой

Railway автоматически обнаружит конфигурацию из `railway.json` и `nixpacks.toml`:

- **Builder**: NIXPACKS (автоматически)
- **Start Command**: `php -S 0.0.0.0:${PORT} -t .`
- **Public**: Включено (приложение будет доступно публично)

### 6. Получение домена

1. После успешного деплоя Railway предоставит домен
2. Вы можете настроить кастомный домен в настройках сервиса

## Структура файлов для Railway

- `railway.json` - конфигурация Railway
- `nixpacks.toml` - конфигурация сборки (PHP, зависимости, расширения)
- `composer.json` - зависимости PHP
- `.env.example` - пример переменных окружения (для локальной разработки)

## Важные замечания

### Переменные окружения

Приложение автоматически использует переменные окружения Railway:
- `MYSQL_HOST`, `MYSQL_DATABASE`, `MYSQL_USER`, `MYSQL_PASSWORD`, `MYSQL_PORT`
- `PORT` - автоматически устанавливается Railway

### Файловые загрузки

- Директория `uploads/` создается автоматически при сборке
- **Важно**: В Railway файловая система эфемерная, загруженные файлы будут потеряны при перезапуске
- Рекомендуется использовать внешнее хранилище (S3, Cloudinary) для production

### Первый вход

После деплоя используйте тестовые учетные данные:
- **Администратор**: `admin` / `admin123`
- **Пользователь**: создайте через регистрацию

## Устранение проблем

### Ошибка подключения к базе данных

1. Убедитесь, что MySQL сервис запущен
2. Проверьте переменные окружения в Railway Dashboard
3. Убедитесь, что база данных инициализирована (выполнены SQL скрипты)

### Ошибка 500

1. Проверьте логи в Railway Dashboard
2. Убедитесь, что все зависимости установлены (`composer install`)
3. Проверьте права доступа к директории `uploads/`

### Файлы не загружаются

1. Убедитесь, что директория `uploads/` существует и имеет права на запись
2. Проверьте настройки `php.ini` для `upload_max_filesize` и `post_max_size`

## Мониторинг

- Логи доступны в Railway Dashboard в реальном времени
- Метрики использования ресурсов отображаются на вкладке "Metrics"

## Обновление приложения

Просто сделайте `git push` в ваш репозиторий - Railway автоматически пересоберет и задеплоит новую версию.

